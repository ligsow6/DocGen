# DocGen - Specification technique (Etape 1)

## Objectif
Definir un cadre clair et stable pour DocGen (CLI Python) afin de generer une documentation standardisee a partir d'un depot Git local. Cette specification fixe les conventions, les structures de donnees, les formats de sortie et le comportement attendu sans implementer l'application.

## Perimetre
Inclus dans l'etape 1 (cadrage & specifications):
- Strategie de zones gerees (markers, remplacement, erreurs)
- Contrat de generation des fichiers Markdown
- Contrat interne de detection (modele de scan)
- Comportement attendu des commandes CLI
- Exigences non-fonctionnelles minimales

Hors perimetre:
- Implementation du scan, parsing ou generation
- Integration CI/CD reelle, publication GitHub Pages ou Doxygen reelle

## Definitions
- Depot cible: repertoire Git local analyse par DocGen.
- Zone geree: section delimitee par markers dont le contenu est entierement remplace par DocGen.
- Contenu manuel: tout contenu hors zones gerees, jamais modifie par DocGen.
- Output dir: repertoire de sortie configure pour stocker les fichiers generes.

## Contrats

### A) Strategie "zones gerees"

**Markers (format exact)**
Les markers sont des commentaires HTML sur une seule ligne. Ils doivent etre exacts, sensibles a la casse, et porter un `id` unique.

```
<!-- DOCGEN:BEGIN id="readme.summary" -->
... contenu gere ...
<!-- DOCGEN:END id="readme.summary" -->
```

Regles:
- Chaque `BEGIN` doit avoir un `END` avec le meme `id`.
- Les zones ne peuvent pas s'imbriquer.
- Les `id` doivent etre uniques dans un fichier.
- Le contenu gere est totalement remplace par DocGen a chaque `build`.

**Remplacement et preservation**
- DocGen lit le fichier, detecte toutes les zones gerees valides, et remplace uniquement leur contenu interne.
- Tout contenu hors zones gerees est preserve tel quel (octet pour octet).
- L'ordre des sections gerees est stable et identique a celui du template DocGen.

**Si markers absents**
- Si le fichier n'existe pas: DocGen cree le fichier complet a partir d'un template (avec zones gerees et sections manuelles vides).
- Si le fichier existe mais sans markers: DocGen ajoute une section "## Documentation generee" en fin de fichier contenant toutes les zones gerees attendues pour ce type de fichier.

**Markers corrompus**
Cas d'erreurs:
- `BEGIN` sans `END` correspondant
- `END` sans `BEGIN`
- `id` duplique
- Zones imbriquees

Comportement:
- `docgen build` echoue (code de sortie non-zero)
- Aucun fichier n'est modifie
- Un message d'erreur clair indique le fichier et le probleme

### B) Contrat de generation des docs

**Emplacement des fichiers**
- `output_dir` defini dans `docgen.yaml` est la racine de sortie.
- Valeur par defaut en absence de config: `docs/`.
- Si `output_dir` vaut `.`, les fichiers sont generes a la racine du depot.

**Fichiers minimum**
- `README.md`
- `ARCHITECTURE.md`

**Encart "Generated by DocGen"**
- Doit apparaitre dans chaque zone geree, sous forme d'un paragraphe court.
- Exemple (dans la zone geree): `> Generated by DocGen. Do not edit this block manually.`

**Structure minimale des sections (ordre stable)**

README.md (template lorsque le fichier est cree par DocGen):
1. `# <Project Name>` (manuel, hors zones gerees)
2. `## Summary` (zone geree `readme.summary`)
3. `## Stack` (zone geree `readme.stack`)
4. `## Commands` (zone geree `readme.commands`)
5. `## Documentation` (zone geree `readme.documentation`)
6. `## Notes manuelles` (manuel)

ARCHITECTURE.md (template lorsque le fichier est cree par DocGen):
1. `# Architecture` (manuel)
2. `## Overview` (zone geree `arch.overview`)
3. `## Components` (zone geree `arch.components`)
4. `## Data flow` (zone geree `arch.data_flow`)
5. `## Deployment` (zone geree `arch.deployment`)
6. `## Notes manuelles` (manuel)

**Insertion dans fichier existant sans markers**
- DocGen ajoute en fin de fichier une section `## Documentation generee`.
- Cette section contient les zones gerees attendues (meme ordre que le template).
- Le contenu existant est preserve.

### C) Contrat de detection (modele interne)

**Modele ProjectInfo (interne)**
- `project_name` (string)
- `repo_root` (string)
- `stacks` (liste d'objets `{name, confidence, evidence, attributes}`)\n  - `confidence`: float 0.0-1.0\n  - `evidence`: liste de chemins d'indices (ex: `package.json`)\n  - `attributes` (optionnel): infos additionnelles (ex: `package_manager`, `typescript`, `tool`)\n+- `files_detected` (liste d'objets `path`, `type`)
- `commands` (objet avec `run`, `test`, `lint`, `build`, `format`)
- `ci` (liste de strings, ex: `github_actions`, `gitlab_ci`)
- `docs` (objet pour chemins/urls detectes)
- `package_manager` (optionnel, ex: `npm`, `yarn`, `pnpm`)
- `python_tooling` (optionnel, ex: `poetry`)
- `warnings` (liste de strings, optionnelle)

**Regles de detection (haut niveau)**
- Python: presence de `pyproject.toml`, `requirements.txt`, `setup.cfg`.
- Node: presence de `package.json`.
- Docker: presence de `Dockerfile`, `docker-compose.yml`.
- CI: presence de `.github/workflows/*.yml` ou `.gitlab-ci.yml`.
- Commandes: derivees de `package.json` (scripts), `pyproject.toml` (tool poetry/pdm), ou defaults simples si inconnues.

### D) CLI - comportement attendu (spec)

`docgen init`
- Cree `docgen.yaml` si absent.
- Contenu minimal:
  - `output_dir: docs`
  - `exclude: [".git/", "node_modules/", "dist/", "build/"]`
  - `readme_target: output`
  - `enable_github_pages: true`
  - `enable_doxygen_block: auto`
- Cree le dossier `output_dir` si absent.
- Cree des fichiers templates `README.md` et `ARCHITECTURE.md` avec zones gerees si absents.
- Ne modifie pas de fichiers existants qui contiennent deja des zones gerees.

`docgen scan`
- Analyse le depot et produit un modele `ProjectInfo`.
- Affiche un resume humain sur stdout.
- Peut ecrire un fichier JSON (interne) pour debug si option `--json` (optionnelle, non obligatoire en V1).
- Codes de sortie:
  - `0` succes
  - `2` erreur de configuration (yaml invalide, output_dir invalide)
  - `3` erreur de scan (permissions, depot illisible)

`docgen build`
- Genere ou met a jour `README.md` et `ARCHITECTURE.md` dans `output_dir`.
- Remplace uniquement le contenu dans les zones gerees.
- Ne supprime aucun contenu manuel.
- Idempotent: deux executions consecutives sans changement donnent des fichiers identiques.
- En cas de markers corrompus: echec et aucun fichier modifie.

### E) Exigences non-fonctionnelles minimales
- Determinisme: pour un meme depot, sorties identiques.
- Idempotence stricte sur `docgen build`.
- Compatible Windows/macOS/Linux (chemins, encodage UTF-8 sans BOM).
- Performance simple: respecter `exclude` et ignorer `node_modules/`, `.git/`, `dist/`, `build/` par defaut.
- Aucun acces reseau requis.

## Exemples
Voir `docs/examples/` pour des exemples de README et ARCHITECTURE avec zones gerees.

## Erreurs & edge cases
- Fichier existant avec markers mais structure differente: DocGen ne reordonne pas les sections, il remplace seulement le contenu des zones reconnues.
- Markers inconnus: ignores (si un id n'est pas gere par DocGen, il est laisse tel quel).
- `output_dir` absent ou non ecrivable: erreur de configuration.
- Depot sans stack detectee: DocGen produit des sections vides avec message "Stack non detectee" dans les zones gerees.

## Criteres d'acceptation
- Les markers exacts sont documentes et tests manuels possibles.
- Un fichier avec contenu manuel est preserve apres `docgen build`.
- Les fichiers generes respectent l'ordre des sections defini.
- `docgen build` est idempotent.
- Les erreurs de markers corrompus ne modifient aucun fichier.
